# GitHub Copilot Instructions for Mixpanel Unity SDK

## Project Overview

This is the **Mixpanel Unity SDK** - an analytics library for Unity applications. Current version: 3.5.3.

- Unity package distributed via Unity Package Manager (UPM)
- Supports Unity 2018.3+ (requires .NET 4.x Equivalent for older versions)
- No test suite in main package (separate `Tests.unitypackage` available)

## Core Architecture

### Static Singleton Pattern with MonoBehaviour Lifecycle

The SDK uses a unique architecture combining static APIs with Unity lifecycle management:

- **`Mixpanel`** (static partial class in `MixpanelAPI.cs`) - Public API surface
- **`Controller`** (MonoBehaviour singleton in `Controller.cs`) - Background worker managing flush intervals
- **`MixpanelStorage`** (static class in `Storage.cs`) - Persistence using `PlayerPreferences` or custom `IPreferences`
- **`Value`** (serializable class in `Value.cs`) - JSON-like data structure with Unity type support

### Key Data Flow

```
Track() → DoTrack() → Merge properties → EnqueueTrackingData() → Periodic Flush → HTTP POST
```

Events queue in PlayerPreferences with auto-incrementing IDs, batch flush every 60s (configurable).

## Essential Patterns

### API Method Structure

All public methods follow this pattern:

```csharp
public static void MethodName(params)
{
    if (!IsInitialized()) return;
    // Implementation calling Controller.DoTrack() or Controller.DoEngage()
}
```

### Initialization Hooks

- Auto-initialize via `[RuntimeInitializeOnLoadMethod(RuntimeInitializeLoadType.BeforeSceneLoad)]`
- Manual initialization available via `Config.ManualInitialization` setting
- Settings loaded from `MixpanelSettings` ScriptableObject in Project Settings

### Token Management Pattern

```csharp
internal string Token {
    get {
        #if UNITY_EDITOR || DEBUG
        return DebugToken;  // Used in Editor/Debug builds
        #else
        return RuntimeToken; // Used in production builds
        #endif
    }
}
```

### Value Object Usage

The `Value` class handles complex data serialization:

```csharp
var props = new Value();
props["key"] = "value";           // Indexer syntax
props["array"] = new Value {1, 2, 3}; // Array operations
props.Merge(otherValue);          // Merge operations
```

## Development Workflows

### Version Updates

**Automated (recommended)**:
```bash
python scripts/release.py --old 3.5.3 --new 3.5.4
```
This handles version updates, commit, tag creation, and push in one command.

**Manual process**:
1. Update `MixpanelUnityVersion` constant in `MixpanelAPI.cs:21`
2. Update version in `package.json:4`
3. Update `CHANGELOG.md`
4. Tag release: `git tag -a v3.5.4 -m "version 3.5.4" && git push origin --tags`

### Package Installation

Local development in `Packages/manifest.json`:

```json
"com.mixpanel.unity": "file:/path/to/cloned/mixpanel-unity"
```

### Debugging

- Enable `ShowDebug` in Unity Project Settings → Mixpanel
- Use `Mixpanel.Log()` for logging (respects `Config.ShowDebug`)
- Check initialization state with `IsInitialized()`

## Platform-Specific Considerations

### Unity Editor vs Runtime

- Use `#if UNITY_EDITOR || DEBUG` for editor-specific code
- Settings UI only available in Editor via `MixpanelSettingsEditor.cs`
- `.meta` files required for all assets (auto-generated by Unity)

### iOS Integration

- iOS-specific code guarded by `#if UNITY_IOS`
- Network reachability via `Application.internetReachability`
- Uses Unity coroutines (not native threads) for async operations

## Common Implementation Patterns

### Adding New Public API Methods

1. Add static method to `Mixpanel` class in `MixpanelAPI.cs`
2. Include `IsInitialized()` guard clause
3. Add XML documentation with `<summary>`, `<param>` tags
4. Call `Controller.DoTrack()` for events or `Controller.DoEngage()` for People operations

### Working with Default Properties

- Event auto-properties: `Controller.GetEventsDefaultProperties()`
- People auto-properties: `Controller.GetEngageDefaultProperties()`
- Properties auto-merged in `DoTrack()` and `DoEngage()` methods

### Migration Support

- V1→V2 migration handled in `Controller.MigrateFrom1To2()`
- Migration state tracked via `MixpanelStorage.HasMigratedFrom1To2`

## Critical Files for Understanding

- **`MixpanelAPI.cs`** - Complete public API surface including nested `Mixpanel.People` class
- **`Controller.cs`** - Initialization logic, flush timing, auto-properties collection
- **`MixpanelSettings.cs`** - Configuration ScriptableObject with Editor integration
- **`Value.cs`** - Complex serialization logic supporting Unity types (Vector, Quaternion, etc.)
- **`Storage.cs`** - Persistence abstractions and data migration logic
